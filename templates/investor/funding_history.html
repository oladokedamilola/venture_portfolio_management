{% extends 'base_user.html' %}
{% load static %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-1">Funding History</h1>
            <p class="text-muted">Complete history of your investments</p>
        </div>
        <div class="btn-group">
            <button class="btn btn-outline-primary" onclick="exportToCSV()">
                <i class="fas fa-download me-2"></i>Export CSV
            </button>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="row mb-4">
        <div class="col-xl-2 col-md-4 mb-4">
            <div class="dashboard-card text-center">
                <h4 class="mb-1">{{ total_investments }}</h4>
                <small class="text-muted">Total Investments</small>
            </div>
        </div>
        <div class="col-xl-2 col-md-4 mb-4">
            <div class="dashboard-card text-center">
                <h4 class="mb-1 text-success">{{ active_investments }}</h4>
                <small class="text-muted">Active</small>
            </div>
        </div>
        <div class="col-xl-2 col-md-4 mb-4">
            <div class="dashboard-card text-center">
                <h4 class="mb-1 text-info">{{ exited_investments }}</h4>
                <small class="text-muted">Exited</small>
            </div>
        </div>
        <div class="col-xl-2 col-md-4 mb-4">
            <div class="dashboard-card text-center">
                <h4 class="mb-1 text-warning">{{ written_off_investments }}</h4>
                <small class="text-muted">Written Off</small>
            </div>
        </div>
        <div class="col-xl-2 col-md-4 mb-4">
            <div class="dashboard-card text-center">
                <h4 class="mb-1 text-nest-green">${{ total_invested|floatformat:0|intcomma }}</h4>
                <small class="text-muted">Total Invested</small>
            </div>
        </div>
        <div class="col-xl-2 col-md-4 mb-4">
            <div class="dashboard-card text-center">
                <h4 class="mb-1 {% if total_return >= 0 %}text-success{% else %}text-danger{% endif %}">
                    ${{ total_return|floatformat:0|intcomma }}
                </h4>
                <small class="text-muted">Total Return</small>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-3">
                    <label class="form-label">Status</label>
                    <select class="form-control" onchange="filterByStatus(this.value)">
                        <option value="">All Status</option>
                        <option value="active">Active</option>
                        <option value="exited">Exited</option>
                        <option value="written_off">Written Off</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Funding Round</label>
                    <select class="form-control" onchange="filterByRound(this.value)">
                        <option value="">All Rounds</option>
                        <option value="pre_seed">Pre-Seed</option>
                        <option value="seed">Seed</option>
                        <option value="series_a">Series A</option>
                        <option value="series_b">Series B</option>
                        <option value="series_c">Series C+</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Date Range</label>
                    <select class="form-control" onchange="filterByDateRange(this.value)">
                        <option value="">All Time</option>
                        <option value="this_year">This Year</option>
                        <option value="last_year">Last Year</option>
                        <option value="last_5_years">Last 5 Years</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">ROI Range</label>
                    <select class="form-control" onchange="filterByROI(this.value)">
                        <option value="">All ROI</option>
                        <option value="positive">Positive</option>
                        <option value="negative">Negative</option>
                        <option value="high_performer">> 100% ROI</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- Investments Table -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0">Investment History</h5>
            <div class="d-flex gap-2">
                <input type="text" class="form-control form-control-sm" placeholder="Search investments..." 
                       onkeyup="searchInvestments(this.value)" style="width: 200px;">
            </div>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover" id="investmentsTable">
                    <thead>
                        <tr>
                            <th>Startup</th>
                            <th>Industry</th>
                            <th>Round</th>
                            <th>Date</th>
                            <th>Amount</th>
                            <th>Equity</th>
                            <th>Valuation</th>
                            <th>Current Value</th>
                            <th>ROI</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for investment in investments %}
                        <tr class="investment-row" 
                            data-status="{{ investment.status }}"
                            data-round="{{ investment.round }}"
                            data-roi="{{ investment.roi }}"
                            data-date="{{ investment.date|date:'Y-m-d' }}">
                            <td>
                                <div class="d-flex align-items-center">
                                    {% if investment.startup.logo %}
                                    <img src="{{ investment.startup.logo.url }}" alt="{{ investment.startup.name }} logo" 
                                         class="rounded me-2" style="width: 30px; height: 30px; object-fit: cover;">
                                    {% endif %}
                                    <strong>{{ investment.startup.name }}</strong>
                                </div>
                            </td>
                            <td>{{ investment.startup.industry|title }}</td>
                            <td>
                                <span class="badge bg-earth text-white">
                                    {{ investment.get_round_display }}
                                </span>
                            </td>
                            <td>{{ investment.date|date:"M d, Y" }}</td>
                            <td>
                                <strong>${{ investment.amount|floatformat:0|intcomma }}</strong>
                            </td>
                            <td>
                                <span class="text-muted">{{ investment.equity }}%</span>
                            </td>
                            <td>
                                <small>${{ investment.valuation|floatformat:0|intcomma }}</small>
                            </td>
                            <td>
                                <strong>${{ investment.current_value|floatformat:0|intcomma }}</strong>
                            </td>
                            <td>
                                <span class="badge {% if investment.roi >= 0 %}bg-success{% else %}bg-danger{% endif %}">
                                    {{ investment.roi }}%
                                </span>
                            </td>
                            <td>
                                <span class="badge 
                                    {% if investment.status == 'active' %}bg-success
                                    {% elif investment.status == 'exited' %}bg-info
                                    {% else %}bg-warning{% endif %}">
                                    {{ investment.get_status_display }}
                                </span>
                            </td>
                            <td>
                                <div class="btn-group">
                                    <a href="{% url 'investor_startup_detail' investment.startup.id %}" 
                                       class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    <button class="btn btn-sm btn-outline-info" 
                                            onclick="showInvestmentDetails({{ investment.id }})">
                                        <i class="fas fa-info-circle"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="11" class="text-center py-4">
                                <i class="fas fa-history fa-3x text-muted mb-3"></i>
                                <h5>No investment history</h5>
                                <p class="text-muted">Your investment history will appear here once you make investments.</p>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Performance Summary -->
    <div class="row mt-4">
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Performance by Round</h5>
                </div>
                <div class="card-body">
                    <canvas id="roundPerformanceChart" height="250"></canvas>
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Annual Investment Activity</h5>
                </div>
                <div class="card-body">
                    <canvas id="annualActivityChart" height="250"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Investment Details Modal -->
<div class="modal fade" id="investmentDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Investment Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="investmentDetailsContent">
                <!-- Content will be loaded via JavaScript -->
            </div>
        </div>
    </div>
</div>

<script>
function filterByStatus(status) {
    filterTable('status', status);
}

function filterByRound(round) {
    filterTable('round', round);
}

function filterByDateRange(range) {
    // Implementation for date range filtering
    filterTable('date-range', range);
}

function filterByROI(roiFilter) {
    filterTable('roi', roiFilter);
}

function filterTable(type, value) {
    const rows = document.querySelectorAll('.investment-row');
    const today = new Date();
    
    rows.forEach(row => {
        let show = true;
        
        switch(type) {
            case 'status':
                if (value && row.dataset.status !== value) show = false;
                break;
            case 'round':
                if (value && row.dataset.round !== value) show = false;
                break;
            case 'roi':
                if (value === 'positive' && parseFloat(row.dataset.roi) < 0) show = false;
                if (value === 'negative' && parseFloat(row.dataset.roi) >= 0) show = false;
                if (value === 'high_performer' && parseFloat(row.dataset.roi) < 100) show = false;
                break;
        }
        
        row.style.display = show ? '' : 'none';
    });
}

function searchInvestments(query) {
    const rows = document.querySelectorAll('.investment-row');
    const searchTerm = query.toLowerCase();
    
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchTerm) ? '' : 'none';
    });
}

function exportToCSV() {
    // Implementation for CSV export
    alert('Export functionality would be implemented here');
}

function showInvestmentDetails(investmentId) {
    // Implementation for showing investment details in modal
    document.getElementById('investmentDetailsContent').innerHTML = `
        <div class="text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    `;
    
    const modal = new bootstrap.Modal(document.getElementById('investmentDetailsModal'));
    modal.show();
    
    // In a real implementation, you would fetch the details via AJAX
    setTimeout(() => {
        document.getElementById('investmentDetailsContent').innerHTML = `
            <p>Detailed investment information would be loaded here for investment ID: ${investmentId}</p>
        `;
    }, 1000);
}

// Initialize charts
document.addEventListener('DOMContentLoaded', function() {
    // Round Performance Chart
    const roundCtx = document.getElementById('roundPerformanceChart').getContext('2d');
    new Chart(roundCtx, {
        type: 'bar',
        data: {
            labels: ['Pre-Seed', 'Seed', 'Series A', 'Series B', 'Series C+'],
            datasets: [{
                label: 'Average ROI (%)',
                data: [45, 68, 32, 25, 18],
                backgroundColor: 'var(--color-nest-green)'
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });

    // Annual Activity Chart
    const annualCtx = document.getElementById('annualActivityChart').getContext('2d');
    new Chart(annualCtx, {
        type: 'line',
        data: {
            labels: ['2019', '2020', '2021', '2022', '2023', '2024'],
            datasets: [{
                label: 'Investments Made',
                data: [3, 5, 8, 6, 7, 4],
                borderColor: 'var(--color-sky-blue)',
                backgroundColor: 'rgba(66, 165, 245, 0.1)',
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true
        }
    });
});
</script>
{% endblock %}