{% extends 'base_user.html' %}
{% load static %}
{% load humanize %}

{% block content %}
<div class="container-fluid py-4">

    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-1">Funding History</h1>
            <p class="text-muted">Track your investment activity and performance</p>
        </div>
        <div class="btn-group">
            {% comment %} <button class="btn btn-outline-primary" onclick="exportToCSV()">
                <i class="fas fa-download me-2"></i>Export CSV
            </button> {% endcomment %}
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="row mb-4">
        <div class="col-md-3 mb-3">
            <div class="dashboard-card text-center">
                <h4 class="mb-1 text-nest-green">${{ total_invested|floatformat:0|intcomma }}</h4>
                <small class="text-muted">Total Invested</small>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="dashboard-card text-center">
                <h4 class="mb-1">{{ total_deals }}</h4>
                <small class="text-muted">Total Deals</small>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="dashboard-card text-center">
                <h4 class="mb-1 text-info">{{ yearly_totals|length }}</h4>
                <small class="text-muted">Active Years</small>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="dashboard-card text-center">
                <h4 class="mb-1 text-success">
                    {% if total_deals > 0 %}
                        ${{ total_invested|divisibleby:total_deals|floatformat:0 }}
                    {% else %}
                        $0
                    {% endif %}
                </h4>
                <small class="text-muted">Avg Investment</small>
            </div>
        </div>
    </div>

    <!-- Investments Table -->
    <div class="card shadow-sm">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0">Investment Records</h5>
            <input type="text" class="form-control form-control-sm" placeholder="Search..." onkeyup="searchInvestments(this.value)" style="width: 200px;">
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>Startup</th>
                            <th>Industry</th>
                            <th>Round</th>
                            <th>Date</th>
                            <th>Amount</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for investment in investments %}
                        <tr>
                            <td>{{ investment.startup.name }}</td>
                            <td>{{ investment.startup.industry }}</td>
                            <td>{{ investment.get_round_display }}</td>
                            <td>{{ investment.investment_date|date:"M d, Y" }}</td>
                            <td>${{ investment.amount|floatformat:0|intcomma }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="5" class="text-center py-4 text-muted">
                                <i class="fas fa-info-circle me-2"></i>No investment records found.
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Charts -->
    <div class="row mt-5">
        <div class="col-lg-6 mb-4">
            <div class="card shadow-sm">
                <div class="card-header">
                    <h5 class="card-title mb-0">Investments by Round</h5>
                </div>
                <div class="card-body">
                    <canvas id="roundChart" height="250"></canvas>
                </div>
            </div>
        </div>

        <div class="col-lg-6 mb-4">
            <div class="card shadow-sm">
                <div class="card-header">
                    <h5 class="card-title mb-0">Yearly Investment Totals</h5>
                </div>
                <div class="card-body">
                    <canvas id="yearlyChart" height="250"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ChartJS -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // ===== Dynamic Data from Django Context =====
    const yearlyLabels = [
        {% for y in yearly_totals reversed %}
            "{{ y.investment_date__year }}",
        {% endfor %}
    ];
    const yearlyData = [
        {% for y in yearly_totals reversed %}
            {{ y.total_amount|floatformat:2 }},
        {% endfor %}
    ];

    const labels = yearlyLabels.length ? yearlyLabels : ['No Data'];
    const data = yearlyData.length ? yearlyData : [0];

    // ====== Chart 1: Yearly Investment Totals ======
    const yearlyCtx = document.getElementById('yearlyChart');
    new Chart(yearlyCtx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Total Invested ($)',
                data: data,
                borderColor: '#10b981',
                backgroundColor: 'rgba(16, 185, 129, 0.15)',
                fill: true,
                tension: 0.4,
                pointRadius: 5,
                pointHoverRadius: 7
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: { beginAtZero: true, title: { display: true, text: 'Investment Amount ($)' } },
                x: { title: { display: true, text: 'Year' } }
            }
        }
    });

    // ====== Chart 2: Investments by Round ======
    const roundLabels = ['Pre-Seed', 'Seed', 'Series A', 'Series B', 'Series C+'];
    const roundData = [5, 8, 3, 2, 1];  // <-- Hardcoded example values; update later dynamically

    new Chart(document.getElementById('roundChart'), {
        type: 'bar',
        data: {
            labels: roundLabels,
            datasets: [{
                label: 'Number of Investments',
                data: roundData,
                backgroundColor: '#3b82f6'
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: { beginAtZero: true, title: { display: true, text: 'Count' } }
            }
        }
    });
});
</script>

<style>
.dashboard-card {
    background: #fff;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    padding: 1.5rem;
    transition: all 0.3s ease;
}
.dashboard-card:hover { box-shadow: 0 4px 6px rgba(0,0,0,0.05); transform: translateY(-2px); }
.text-nest-green { color: #10b981 !important; }
</style>
{% endblock %}
