{% extends 'base_user.html' %}
{% load static %}
{% load humanize %}

{% block title %}{{ project.name }} - VentureNest{% endblock %}

{% block page_title %}{{ project.name }}{% endblock %}
{% block page_subtitle %}{{ project.startup.name }} â€¢ {{ project.get_status_display }}{% endblock %}

{% block page_actions %}
<div class="btn-group">
    <a href="#" class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#editProjectModal">
        <i class="bi bi-pencil me-1"></i>Edit
    </a>
    <button class="btn btn-outline-primary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
        <i class="bi bi-three-dots-vertical"></i>
    </button>
    <ul class="dropdown-menu">
        <li><a class="dropdown-item" href="#">
            <i class="bi bi-clipboard-check me-2"></i>Mark Complete
        </a></li>
        <li><a class="dropdown-item" href="#">
            <i class="bi bi-archive me-2"></i>Archive
        </a></li>
        <li><hr class="dropdown-divider"></li>
        <li><a class="dropdown-item text-danger" href="#">
            <i class="bi bi-trash me-2"></i>Delete
        </a></li>
    </ul>
</div>
{% endblock %}

{% block content %}
<div class="row">
    <!-- Main Content -->
    <div class="col-lg-8">
        <!-- Project Overview -->
        <div class="card shadow-sm border-0 mb-4">
            <div class="card-header bg-white py-3">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-info-circle text-nest me-2"></i>Project Overview
                    </h5>
                    <div class="d-flex gap-2">
                        <span class="badge {% if project.status == 'completed' %}bg-success{% elif project.status == 'in_progress' %}bg-primary{% elif project.status == 'on_hold' %}bg-warning{% else %}bg-secondary{% endif %}">
                            {{ project.get_status_display }}
                        </span>
                        <span class="badge {% if project.priority == 'high' %}bg-danger{% elif project.priority == 'medium' %}bg-warning{% else %}bg-info{% endif %}">
                            {{ project.get_priority_display }} Priority
                        </span>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="row mb-4">
                    <div class="col-md-8">
                        <p class="text-muted mb-3">{{ project.description }}</p>
                        
                        <!-- Key Metrics -->
                        <div class="row text-center mb-4">
                            <div class="col-3">
                                <div class="metric-value fw-bold text-nest">{{ completion_rate|floatformat:0 }}%</div>
                                <small class="text-muted">Progress</small>
                            </div>
                            <div class="col-3">
                                <div class="metric-value fw-bold text-nest">{{ completed_tasks }}/{{ total_tasks }}</div>
                                <small class="text-muted">Tasks Done</small>
                            </div>
                            <div class="col-3">
                                <div class="metric-value fw-bold text-nest">
                                    {% if project.due_date %}
                                        {{ project.due_date|timeuntil }}
                                    {% else %}
                                        No due date
                                    {% endif %}
                                </div>
                                <small class="text-muted">Time Left</small>
                            </div>
                            <div class="col-3">
                                <div class="metric-value fw-bold text-nest">{{ project.team_members.count }}</div>
                                <small class="text-muted">Team Members</small>
                            </div>
                        </div>

                        <!-- Progress Bar -->
                        <div class="mb-4">
                            <div class="d-flex justify-content-between mb-2">
                                <span class="fw-semibold">Overall Progress</span>
                                <span class="text-muted">{{ completion_rate|floatformat:0 }}%</span>
                            </div>
                            <div class="progress" style="height: 10px;">
                                <div class="progress-bar bg-success" style="width: {{ completion_rate }}%"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="project-timeline">
                            <div class="timeline-item mb-3">
                                <div class="text-muted small">Start Date</div>
                                <div class="fw-semibold">{{ project.start_date|date:"M d, Y"|default:"Not set" }}</div>
                            </div>
                            <div class="timeline-item mb-3">
                                <div class="text-muted small">Due Date</div>
                                <div class="fw-semibold">{{ project.due_date|date:"M d, Y"|default:"Not set" }}</div>
                            </div>
                            <div class="timeline-item">
                                <div class="text-muted small">Last Updated</div>
                                <div class="fw-semibold">{{ project.updated_at|timesince }} ago</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Key Details -->
                <div class="row">
                    <div class="col-md-6">
                        <table class="table table-sm table-borderless">
                            <tr>
                                <td class="text-muted">Startup:</td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        {% if project.startup.logo and project.startup.logo.url %}
                                        <img src="{{ project.startup.logo.url }}" 
                                             alt="{{ project.startup.name }}" 
                                             class="rounded-circle me-2" 
                                             width="24" 
                                             height="24">
                                        {% else %}
                                        <div class="rounded-circle bg-light d-flex align-items-center justify-content-center me-2" 
                                             width="24" 
                                             height="24">
                                            <i class="bi bi-building text-muted" style="font-size: 0.8rem;"></i>
                                        </div>
                                        {% endif %}
                                        <span class="fw-semibold">{{ project.startup.name }}</span>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td class="text-muted">Project Lead:</td>
                                <td class="fw-semibold">
                                    {% if project.project_lead %}
                                        {{ project.project_lead.get_full_name|default:project.project_lead.username }}
                                    {% else %}
                                        Not assigned
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <td class="text-muted">Budget:</td>
                                <td class="fw-semibold">
                                    {% if project.budget %}
                                        ${{ project.budget|intcomma }}
                                    {% else %}
                                        Not set
                                    {% endif %}
                                </td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <table class="table table-sm table-borderless">
                            <tr>
                                <td class="text-muted">Category:</td>
                                <td class="fw-semibold">{{ project.category|default:"Not specified" }}</td>
                            </tr>
                            <tr>
                                <td class="text-muted">Created:</td>
                                <td class="fw-semibold">{{ project.created_at|date:"M d, Y" }}</td>
                            </tr>
                            <tr>
                                <td class="text-muted">Overdue Tasks:</td>
                                <td class="fw-semibold {% if overdue_tasks.count > 0 %}text-danger{% endif %}">
                                    {{ overdue_tasks.count }}
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tasks Section -->
        <div class="card shadow-sm border-0 mb-4">
            <div class="card-header bg-white py-3">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-list-check text-nest me-2"></i>Tasks ({{ total_tasks }})
                    </h5>
                    <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addTaskModal">
                        <i class="bi bi-plus-circle me-1"></i>Add Task
                    </button>
                </div>
            </div>
            <div class="card-body p-0">
                {% if tasks %}
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 40px;"></th>
                                <th>Task</th>
                                <th>Assignee</th>
                                <th>Due Date</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for task in tasks %}
                            <tr class="{% if task in overdue_tasks %}table-warning{% endif %}">
                                <td>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" {% if task.status == 'completed' %}checked{% endif %}>
                                    </div>
                                </td>
                                <td>
                                    <div class="fw-semibold">{{ task.title }}</div>
                                    <small class="text-muted">{{ task.description|truncatechars:50|default:"No description" }}</small>
                                </td>
                                <td>
                                    {% if task.assigned_to %}
                                    <div class="d-flex align-items-center">
                                        <div class="rounded-circle bg-primary d-flex align-items-center justify-content-center me-2" 
                                             width="24" 
                                             height="24">
                                            <i class="bi bi-person text-white" style="font-size: 0.8rem;"></i>
                                        </div>
                                        <span>{{ task.assigned_to.get_full_name|default:task.assigned_to.username }}</span>
                                    </div>
                                    {% else %}
                                    <span class="text-muted">Unassigned</span>
                                    {% endif %}
                                </td>
                                <td>{{ task.due_date|date:"M d, Y"|default:"Not set" }}</td>
                                <td>
                                    <span class="badge bg-{% if task.status == 'completed' %}success{% elif task.status == 'in_progress' %}primary{% else %}warning{% endif %}">
                                        {{ task.get_status_display }}
                                    </span>
                                </td>
                                <td>
                                    <div class="dropdown">
                                        <button class="btn btn-sm btn-outline-secondary border-0" data-bs-toggle="dropdown">
                                            <i class="bi bi-three-dots-vertical"></i>
                                        </button>
                                        <ul class="dropdown-menu">
                                            <li><a class="dropdown-item" href="#">Edit</a></li>
                                            <li><a class="dropdown-item" href="#">Reassign</a></li>
                                            <li><a class="dropdown-item text-danger" href="#">Delete</a></li>
                                        </ul>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="bi bi-list-check display-4 text-muted mb-3"></i>
                    <h5 class="text-muted">No Tasks Yet</h5>
                    <p class="text-muted">Get started by adding tasks to this project.</p>
                    <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addTaskModal">
                        <i class="bi bi-plus-circle me-1"></i>Add First Task
                    </button>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Project Timeline -->
        <div class="card shadow-sm border-0 mb-4">
            <div class="card-header bg-white py-3">
                <h5 class="card-title mb-0">
                    <i class="bi bi-clock text-nest me-2"></i>Project Timeline
                </h5>
            </div>
            <div class="card-body">
                <div class="activity-timeline">
                    <div class="activity-item d-flex mb-3">
                        <div class="activity-icon flex-shrink-0 me-3">
                            <i class="bi bi-plus-circle text-success"></i>
                        </div>
                        <div class="activity-content">
                            <div class="fw-semibold">Project Created</div>
                            <small class="text-muted">{{ project.name }} was created</small>
                            <div class="text-muted small">{{ project.created_at|timesince }} ago</div>
                        </div>
                    </div>
                    {% if project.updated_at != project.created_at %}
                    <div class="activity-item d-flex mb-3">
                        <div class="activity-icon flex-shrink-0 me-3">
                            <i class="bi bi-pencil text-primary"></i>
                        </div>
                        <div class="activity-content">
                            <div class="fw-semibold">Project Updated</div>
                            <small class="text-muted">Project details were modified</small>
                            <div class="text-muted small">{{ project.updated_at|timesince }} ago</div>
                        </div>
                    </div>
                    {% endif %}
                    {% if completed_tasks > 0 %}
                    <div class="activity-item d-flex mb-3">
                        <div class="activity-icon flex-shrink-0 me-3">
                            <i class="bi bi-check-circle text-success"></i>
                        </div>
                        <div class="activity-content">
                            <div class="fw-semibold">Tasks Completed</div>
                            <small class="text-muted">{{ completed_tasks }} task{{ completed_tasks|pluralize }} completed</small>
                            <div class="text-muted small">Progress: {{ completion_rate|floatformat:0 }}%</div>
                        </div>
                    </div>
                    {% endif %}
                    {% if overdue_tasks.count > 0 %}
                    <div class="activity-item d-flex">
                        <div class="activity-icon flex-shrink-0 me-3">
                            <i class="bi bi-exclamation-triangle text-warning"></i>
                        </div>
                        <div class="activity-content">
                            <div class="fw-semibold">Overdue Tasks</div>
                            <small class="text-muted">{{ overdue_tasks.count }} task{{ overdue_tasks.count|pluralize }} overdue</small>
                            <div class="text-muted small">Needs attention</div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="col-lg-4">
        <!-- Team Members -->
        <div class="card shadow-sm border-0 mb-4">
            <div class="card-header bg-white py-3">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-people text-nest me-2"></i>Team ({{ project.team_members.count }})
                    </h5>
                    <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#manageTeamModal">
                        Manage
                    </button>
                </div>
            </div>
            <div class="card-body">
                {% if project.team_members.all %}
                <div class="team-members">
                    {% for member in project.team_members.all %}
                    <div class="team-member d-flex align-items-center mb-3">
                        <div class="rounded-circle bg-primary d-flex align-items-center justify-content-center me-3" 
                             width="40" 
                             height="40">
                            <i class="bi bi-person text-white"></i>
                        </div>
                        <div class="flex-grow-1">
                            <div class="fw-semibold">{{ member.get_full_name|default:member.username }}</div>
                            <small class="text-muted">{{ member.role|default:"Team Member" }}</small>
                        </div>
                        <span class="badge bg-success">Active</span>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-3">
                    <i class="bi bi-people display-4 text-muted mb-2"></i>
                    <p class="text-muted">No team members assigned</p>
                    <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#manageTeamModal">
                        Add Team Members
                    </button>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Project Status -->
        <div class="card shadow-sm border-0 mb-4">
            <div class="card-header bg-white py-3">
                <h5 class="card-title mb-0">
                    <i class="bi bi-graph-up text-nest me-2"></i>Project Status
                </h5>
            </div>
            <div class="card-body">
                <div class="status-item mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <span class="text-muted">Completion Rate</span>
                        <span class="fw-semibold">{{ completion_rate|floatformat:0 }}%</span>
                    </div>
                    <div class="progress" style="height: 6px;">
                        <div class="progress-bar bg-success" style="width: {{ completion_rate }}%"></div>
                    </div>
                </div>
                <div class="status-item mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <span class="text-muted">Tasks Completed</span>
                        <span class="fw-semibold">{{ completed_tasks }}/{{ total_tasks }}</span>
                    </div>
                    <div class="progress" style="height: 6px;">
                        <div class="progress-bar bg-info" style="width: {% widthratio completed_tasks total_tasks 100 %}%"></div>
                    </div>
                </div>
                <div class="status-item">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <span class="text-muted">Overdue Tasks</span>
                        <span class="fw-semibold {% if overdue_tasks.count > 0 %}text-danger{% endif %}">
                            {{ overdue_tasks.count }}
                        </span>
                    </div>
                    <div class="progress" style="height: 6px;">
                        <div class="progress-bar {% if overdue_tasks.count > 0 %}bg-warning{% else %}bg-success{% endif %}" 
                             style="width: {% widthratio overdue_tasks.count total_tasks 100 %}%">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="card shadow-sm border-0">
            <div class="card-header bg-white py-3">
                <h5 class="card-title mb-0">
                    <i class="bi bi-lightning text-nest me-2"></i>Quick Actions
                </h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="#" class="btn btn-outline-primary text-start" data-bs-toggle="modal" data-bs-target="#editProjectModal">
                        <i class="bi bi-pencil me-2"></i>Edit Project
                    </a>
                    <button class="btn btn-outline-primary text-start" data-bs-toggle="modal" data-bs-target="#addTaskModal">
                        <i class="bi bi-plus-circle me-2"></i>Add Task
                    </button>
                    <a href="#" class="btn btn-outline-primary text-start">
                        <i class="bi bi-file-earmark-text me-2"></i>Generate Report
                    </a>
                    <a href="{% url 'startups:manager_startup_detail' project.startup.id %}" class="btn btn-outline-primary text-start">
                        <i class="bi bi-building me-2"></i>View Startup
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Task Modal -->
<div class="modal fade" id="addTaskModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Task</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" id="addTaskForm">
                {% csrf_token %}
                <input type="hidden" name="create_task" value="true">
                <div class="modal-body">
                    {% if task_form %}
                    <div class="mb-3">
                        <label for="id_title" class="form-label">Task Title *</label>
                        <input type="text" 
                               name="title" 
                               id="id_title" 
                               class="form-control {% if task_form.title.errors %}is-invalid{% endif %}" 
                               value="{{ task_form.title.value|default:'' }}"
                               placeholder="Enter task title"
                               required>
                        {% if task_form.title.errors %}
                        <div class="invalid-feedback">
                            {{ task_form.title.errors.0 }}
                        </div>
                        {% endif %}
                    </div>
                    
                    <div class="mb-3">
                        <label for="id_description" class="form-label">Description</label>
                        <textarea name="description" 
                                  id="id_description" 
                                  class="form-control {% if task_form.description.errors %}is-invalid{% endif %}" 
                                  rows="3" 
                                  placeholder="Task description...">{{ task_form.description.value|default:'' }}</textarea>
                        {% if task_form.description.errors %}
                        <div class="invalid-feedback">
                            {{ task_form.description.errors.0 }}
                        </div>
                        {% endif %}
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="id_assigned_to" class="form-label">Assignee</label>
                                <select name="assigned_to" 
                                        id="id_assigned_to" 
                                        class="form-select {% if task_form.assigned_to.errors %}is-invalid{% endif %}">
                                    <option value="">Select assignee</option>
                                    {% for member in project.team_members.all %}
                                    <option value="{{ member.id }}" 
                                            {% if task_form.assigned_to.value == member.id %}selected{% endif %}>
                                        {{ member.get_full_name|default:member.username }}
                                    </option>
                                    {% endfor %}
                                </select>
                                {% if task_form.assigned_to.errors %}
                                <div class="invalid-feedback">
                                    {{ task_form.assigned_to.errors.0 }}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="id_due_date" class="form-label">Due Date</label>
                                <input type="date" 
                                       name="due_date" 
                                       id="id_due_date" 
                                       class="form-control {% if task_form.due_date.errors %}is-invalid{% endif %}" 
                                       value="{{ task_form.due_date.value|default:'' }}">
                                {% if task_form.due_date.errors %}
                                <div class="invalid-feedback">
                                    {{ task_form.due_date.errors.0 }}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="id_priority" class="form-label">Priority</label>
                        <select name="priority" 
                                id="id_priority" 
                                class="form-select {% if task_form.priority.errors %}is-invalid{% endif %}">
                            <option value="low" {% if task_form.priority.value == 'low' %}selected{% endif %}>Low</option>
                            <option value="medium" {% if task_form.priority.value == 'medium' %}selected{% endif %}>Medium</option>
                            <option value="high" {% if task_form.priority.value == 'high' %}selected{% endif %}>High</option>
                        </select>
                        {% if task_form.priority.errors %}
                        <div class="invalid-feedback">
                            {{ task_form.priority.errors.0 }}
                        </div>
                        {% endif %}
                    </div>
                    {% else %}
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        Task form not available. Please refresh the page.
                    </div>
                    {% endif %}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Task</button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
    .metric-value {
        font-size: 1.25rem;
    }

    .progress {
        background-color: #e9ecef;
    }

    .activity-icon {
        width: 32px;
        height: 32px;
        background: #f8f9fa;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .team-member:hover {
        background-color: #f8f9fa;
        border-radius: 0.375rem;
        padding: 0.5rem;
        margin: -0.5rem;
    }

    .status-item {
        padding-bottom: 1rem;
        border-bottom: 1px solid #e9ecef;
    }

    .status-item:last-child {
        border-bottom: none;
        padding-bottom: 0;
    }

    .table-warning {
        background-color: rgba(255, 193, 7, 0.1);
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Task completion toggle
        document.querySelectorAll('.form-check-input').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const row = this.closest('tr');
                const statusBadge = row.querySelector('.badge');
                
                if (this.checked) {
                    statusBadge.className = 'badge bg-success';
                    statusBadge.textContent = 'Completed';
                    row.classList.remove('table-warning');
                } else {
                    statusBadge.className = 'badge bg-warning';
                    statusBadge.textContent = 'In Progress';
                    
                    // Check if task is overdue
                    const dueDate = new Date(row.cells[3].textContent);
                    const today = new Date();
                    if (dueDate < today) {
                        row.classList.add('table-warning');
                    }
                }
            });
        });

        // Initialize task status based on checkboxes
        document.querySelectorAll('.form-check-input').forEach(checkbox => {
            if (!checkbox.checked) {
                const row = checkbox.closest('tr');
                const dueDateText = row.cells[3].textContent;
                if (dueDateText && dueDateText !== 'Not set') {
                    const dueDate = new Date(dueDateText);
                    const today = new Date();
                    if (dueDate < today) {
                        row.classList.add('table-warning');
                    }
                }
            }
        });

        // Handle task form submission
        const taskForm = document.getElementById('addTaskForm');
        if (taskForm) {
            taskForm.addEventListener('submit', function(e) {
                // Basic validation
                const title = document.getElementById('id_title').value.trim();
                if (!title) {
                    e.preventDefault();
                    alert('Please enter a task title.');
                    return;
                }
                
                // Show loading state
                const submitBtn = this.querySelector('button[type="submit"]');
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>Adding...';
            });
        }

        // Reset form when modal is closed
        const taskModal = document.getElementById('addTaskModal');
        if (taskModal) {
            taskModal.addEventListener('hidden.bs.modal', function() {
                const form = document.getElementById('addTaskForm');
                if (form) {
                    form.reset();
                    // Re-enable submit button
                    const submitBtn = form.querySelector('button[type="submit"]');
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = 'Add Task';
                    }
                    // Clear validation states
                    form.querySelectorAll('.is-invalid').forEach(el => {
                        el.classList.remove('is-invalid');
                    });
                }
            });
        }
    });
</script>
{% endblock %}