{% extends 'base_user.html' %}
{% load static %}

{% block title %}Edit {{ startup.name }} - VentureNest{% endblock %}

{% block page_title %}Edit Startup{% endblock %}
{% block page_subtitle %}Update {{ startup.name }}'s information and settings{% endblock %}

{% block page_actions %}
<div class="btn-group">
     <a href="{% url 'startups:manager_startup_detail' startup.id %}" class="btn btn-outline-primary btn-sm">
        <i class="bi bi-eye me-1"></i>View Details
    </a> 
    <a href="{% url 'startups:manager_startup_delete' startup.id %}" class="btn btn-outline-danger btn-sm">
    <i class="bi bi-trash me-1"></i>Delete
</a>
</div>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8">
        <div class="card shadow-sm border-0">
            <div class="card-header bg-white py-4">
                <h5 class="card-title mb-0">
                    <i class="bi bi-pencil-square text-nest me-2"></i>Edit Startup Information
                </h5>
            </div>
            <div class="card-body p-4">
                <form method="POST" enctype="multipart/form-data" id="editStartupForm">
                    {% csrf_token %}
                    
                    <!-- Basic Information -->
                    <div class="mb-4">
                        <h6 class="mb-3 text-nest">
                            <i class="bi bi-info-circle me-2"></i>Basic Information
                        </h6>
                        
                        <!-- Startup Name -->
                        <div class="mb-3">
                            <label for="id_name" class="form-label fw-semibold">Startup Name *</label>
                            <input type="text" 
                                   name="name" 
                                   id="id_name" 
                                   class="form-control" 
                                   value="{{ form.name.value|default:startup.name }}"
                                   required>
                            {% if form.name.errors %}
                            <div class="text-danger small">{{ form.name.errors }}</div>
                            {% endif %}
                        </div>

                        <!-- Logo -->
                        <div class="mb-3">
                            <label for="id_logo" class="form-label fw-semibold">Company Logo</label>
                            <div class="d-flex align-items-center">
                                <div class="logo-preview me-3">
                                    {% if startup.logo %}
                                    <img src="{{ startup.logo.url }}" 
                                         alt="Logo preview" 
                                         class="rounded border" 
                                         id="logo-preview"
                                         style="width: 80px; height: 80px; object-fit: cover;">
                                    {% else %}
                                    <div class="rounded border bg-light d-flex align-items-center justify-content-center" 
                                         id="logo-preview"
                                         style="width: 80px; height: 80px;">
                                        <i class="bi bi-building text-muted"></i>
                                    </div>
                                    {% endif %}
                                </div>
                                <div class="flex-grow-1">
                                    <input type="file" 
                                           name="logo" 
                                           id="id_logo" 
                                           class="form-control" 
                                           accept="image/*">
                                    <div class="form-text">
                                        {% if startup.logo %}
                                        <button type="button" class="btn btn-sm btn-outline-danger mt-1" id="removeLogo">
                                            <i class="bi bi-trash me-1"></i>Remove Logo
                                        </button>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            {% if form.logo.errors %}
                            <div class="text-danger small">{{ form.logo.errors }}</div>
                            {% endif %}
                        </div>

                        <!-- Description -->
                        <div class="mb-3">
                            <label for="id_description" class="form-label fw-semibold">Description *</label>
                            <textarea name="description" 
                                      id="id_description" 
                                      class="form-control" 
                                      rows="4"
                                      required>{{ form.description.value|default:startup.description }}</textarea>
                            <div class="form-text">Provide a clear overview of what the startup does.</div>
                            {% if form.description.errors %}
                            <div class="text-danger small">{{ form.description.errors }}</div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Business Details -->
                    <div class="mb-4">
                        <h6 class="mb-3 text-nest">
                            <i class="bi bi-briefcase me-2"></i>Business Details
                        </h6>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="id_industry" class="form-label fw-semibold">Industry *</label>
                                    <select name="industry" id="id_industry" class="form-select" required>
                                        <option value="">Select Industry</option>
                                        {% for value, label in form.fields.industry.choices %}
                                            {% if value %}
                                            <option value="{{ value }}" {% if form.industry.value|default:startup.industry == value %}selected{% endif %}>{{ label }}</option>
                                            {% endif %}
                                        {% endfor %}
                                    </select>
                                    {% if form.industry.errors %}
                                    <div class="text-danger small">{{ form.industry.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="id_stage" class="form-label fw-semibold">Funding Stage *</label>
                                    <select name="stage" id="id_stage" class="form-select" required>
                                        <option value="">Select Stage</option>
                                        {% for value, label in form.fields.stage.choices %}
                                            {% if value %}
                                            <option value="{{ value }}" {% if form.stage.value|default:startup.stage == value %}selected{% endif %}>{{ label }}</option>
                                            {% endif %}
                                        {% endfor %}
                                    </select>
                                    {% if form.stage.errors %}
                                    <div class="text-danger small">{{ form.stage.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="id_location" class="form-label fw-semibold">Location *</label>
                                    <input type="text" 
                                           name="location" 
                                           id="id_location" 
                                           class="form-control" 
                                           value="{{ form.location.value|default:startup.location }}"
                                           required>
                                    {% if form.location.errors %}
                                    <div class="text-danger small">{{ form.location.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="id_founding_date" class="form-label fw-semibold">Founding Date *</label>
                                    <input type="date" 
                                           name="founding_date" 
                                           id="id_founding_date" 
                                           class="form-control"
                                           value="{{ form.founding_date.value|default:startup.founding_date|date:'Y-m-d' }}"
                                           required>
                                    {% if form.founding_date.errors %}
                                    <div class="text-danger small">{{ form.founding_date.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="id_website" class="form-label fw-semibold">Website</label>
                                    <input type="url" 
                                           name="website" 
                                           id="id_website" 
                                           class="form-control" 
                                           value="{{ form.website.value|default:startup.website }}"
                                           placeholder="https://example.com">
                                    {% if form.website.errors %}
                                    <div class="text-danger small">{{ form.website.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="id_team_size" class="form-label fw-semibold">Team Size</label>
                                    <input type="number" 
                                           name="team_size" 
                                           id="id_team_size" 
                                           class="form-control" 
                                           value="{{ form.team_size.value|default:startup.team_size }}"
                                           min="1">
                                    {% if form.team_size.errors %}
                                    <div class="text-danger small">{{ form.team_size.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Market Description -->
                        <div class="mb-3">
                            <label for="id_market" class="form-label fw-semibold">Market Description *</label>
                            <textarea name="market" 
                                      id="id_market" 
                                      class="form-control" 
                                      rows="3"
                                      required>{{ form.market.value|default:startup.market }}</textarea>
                            <div class="form-text">Describe your target market, customers, and opportunity.</div>
                            {% if form.market.errors %}
                            <div class="text-danger small">{{ form.market.errors }}</div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Financial Information -->
                    <div class="mb-4">
                        <h6 class="mb-3 text-nest">
                            <i class="bi bi-currency-dollar me-2"></i>Financial Information
                        </h6>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="id_valuation" class="form-label fw-semibold">Valuation ($)</label>
                                    <div class="input-group">
                                        <span class="input-group-text">$</span>
                                        <input type="number" 
                                               name="valuation" 
                                               id="id_valuation" 
                                               class="form-control" 
                                               value="{{ form.valuation.value|default:startup.valuation }}"
                                               step="0.01"
                                               min="0">
                                    </div>
                                    {% if form.valuation.errors %}
                                    <div class="text-danger small">{{ form.valuation.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="id_monthly_revenue" class="form-label fw-semibold">Monthly Revenue ($)</label>
                                    <div class="input-group">
                                        <span class="input-group-text">$</span>
                                        <input type="number" 
                                               name="monthly_revenue" 
                                               id="id_monthly_revenue" 
                                               class="form-control" 
                                               value="{{ form.monthly_revenue.value|default:startup.monthly_revenue }}"
                                               step="0.01"
                                               min="0">
                                    </div>
                                    {% if form.monthly_revenue.errors %}
                                    <div class="text-danger small">{{ form.monthly_revenue.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Founder Information -->
                    <div class="mb-4">
                        <h6 class="mb-3 text-nest">
                            <i class="bi bi-person me-2"></i>Founder Information
                        </h6>
                        
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Current Founder</label>
                            <div class="p-3 border rounded-3 bg-light">
                                <div class="d-flex align-items-center">
                                    <div class="rounded-circle bg-primary d-flex align-items-center justify-content-center me-3" 
                                         style="width: 50px; height: 50px;">
                                        <i class="bi bi-person text-white"></i>
                                    </div>
                                    <div>
                                        <div class="fw-semibold">
                                            {% if startup.founder %}
                                                {{ startup.founder.get_full_name|default:startup.founder.username }}
                                            {% else %}
                                                No founder assigned
                                            {% endif %}
                                        </div>
                                        <small class="text-muted">Founder & CEO</small>
                                        {% if startup.founder %}
                                        <div class="mt-1">
                                            <span class="text-muted small">
                                                <i class="bi bi-envelope me-1"></i>{{ startup.founder.email }}
                                            </span>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            <div class="form-text mt-2">
                                <small class="text-muted">
                                    Founder assignment is managed automatically when startups are created.
                                    {% if not startup.founder %}
                                    <span class="text-warning">No founder currently assigned to this startup.</span>
                                    {% endif %}
                                </small>
                            </div>
                        </div>
                    </div>

                    <!-- Form Actions -->
                    <div class="d-flex justify-content-between align-items-center pt-3 border-top">
                         <a href="{% url 'startups:manager_startup_detail' startup.id %}" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-left me-1"></i>Cancel
                        </a> 
                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-outline-primary" id="previewBtn">
                                <i class="bi bi-eye me-1"></i>Preview
                            </button>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check-circle me-1"></i>Save Changes
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="col-lg-4">
        <!-- Startup Summary -->
        <div class="card shadow-sm border-0 mb-4">
            <div class="card-header bg-white py-3">
                <h6 class="card-title mb-0">
                    <i class="bi bi-info-circle text-nest me-2"></i>Startup Summary
                </h6>
            </div>
            <div class="card-body">
                <div class="startup-summary">
                    <div class="summary-item mb-2">
                        <small class="text-muted">Created</small>
                        <div class="fw-semibold">{{ startup.created_at|date:"M d, Y" }}</div>
                    </div>
                    <div class="summary-item mb-2">
                        <small class="text-muted">Last Updated</small>
                        <div class="fw-semibold">{{ startup.updated_at|timesince }} ago</div>
                    </div>
                    <div class="summary-item mb-2">
                        <small class="text-muted">Status</small>
                        <div>
                            <span class="badge {% if startup.is_active %}bg-success{% else %}bg-secondary{% endif %}">
                                {% if startup.is_active %}Active{% else %}Inactive{% endif %}
                            </span>
                        </div>
                    </div>
                    <div class="summary-item">
                        <small class="text-muted">Projects</small>
                        <div class="fw-semibold">{{ startup.projects.count }}</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="card shadow-sm border-0">
            <div class="card-header bg-white py-3">
                <h6 class="card-title mb-0">
                    <i class="bi bi-lightning text-nest me-2"></i>Quick Actions
                </h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{% url 'funding:manager_funding_rounds' %}?startup={{ startup.id }}" class="btn btn-outline-primary text-start">
                        <i class="bi bi-currency-dollar me-2"></i>Manage Funding
                    </a>
                    <a href="{% url 'projects:manager_projects' %}?startup={{ startup.id }}" class="btn btn-outline-primary text-start">
                        <i class="bi bi-kanban me-2"></i>View Projects
                    </a>
                    <a href="#" class="btn btn-outline-primary text-start">
                        <i class="bi bi-file-earmark-text me-2"></i>Generate Report
                    </a>
                    <a href="#" class="btn btn-outline-primary text-start">
                        <i class="bi bi-graph-up me-2"></i>Update Metrics
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-danger">
                    <i class="bi bi-exclamation-triangle me-2"></i>Delete Startup
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete <strong>{{ startup.name }}</strong>?</p>
                <p class="text-muted small">
                    This action cannot be undone. All associated data, projects, and funding information will be permanently removed.
                </p>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="confirmDelete">
                    <label class="form-check-label" for="confirmDelete">
                        I understand this action is irreversible
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn" disabled>
                    <i class="bi bi-trash me-1"></i>Delete Startup
                </button>
            </div>
        </div>
    </div>
</div>

<style>
    .form-control:focus, .form-select:focus {
        border-color: var(--color-nest-green);
        box-shadow: 0 0 0 0.2rem rgba(46, 125, 50, 0.1);
    }

    .logo-preview img {
        transition: opacity 0.3s ease;
    }

    .summary-item {
        padding-bottom: 0.5rem;
        border-bottom: 1px solid #e9ecef;
    }

    .summary-item:last-child {
        border-bottom: none;
        padding-bottom: 0;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('editStartupForm');
        const logoInput = document.getElementById('id_logo');
        const logoPreview = document.getElementById('logo-preview');
        const removeLogoBtn = document.getElementById('removeLogo');
        const confirmDelete = document.getElementById('confirmDelete');
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');

        // Logo preview and removal
        if (logoInput) {
            logoInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        if (logoPreview.tagName === 'IMG') {
                            logoPreview.src = e.target.result;
                        } else {
                            // Replace the div with an img
                            const newImg = document.createElement('img');
                            newImg.src = e.target.result;
                            newImg.className = 'rounded border';
                            newImg.style.width = '80px';
                            newImg.style.height = '80px';
                            newImg.style.objectFit = 'cover';
                            newImg.id = 'logo-preview';
                            logoPreview.parentNode.replaceChild(newImg, logoPreview);
                        }
                    }
                    reader.readAsDataURL(file);
                }
            });
        }

        if (removeLogoBtn) {
            removeLogoBtn.addEventListener('click', function() {
                if (logoInput) logoInput.value = '';
                // Replace with default logo display
                const defaultDiv = document.createElement('div');
                defaultDiv.className = 'rounded border bg-light d-flex align-items-center justify-content-center';
                defaultDiv.style.width = '80px';
                defaultDiv.style.height = '80px';
                defaultDiv.id = 'logo-preview';
                defaultDiv.innerHTML = '<i class="bi bi-building text-muted"></i>';
                logoPreview.parentNode.replaceChild(defaultDiv, logoPreview);
            });
        }

        // Delete confirmation
        if (confirmDelete) {
            confirmDelete.addEventListener('change', function() {
                if (confirmDeleteBtn) {
                    confirmDeleteBtn.disabled = !this.checked;
                }
            });
        }

        if (confirmDeleteBtn) {
            confirmDeleteBtn.addEventListener('click', function() {
                // In a real app, this would submit a delete request
                // For now, just redirect to startup list
                window.location.href = "{% url 'startups:manager_startup_list' %}";
            });
        }

        // Form validation
        form.addEventListener('submit', function(e) {
            const requiredFields = [
                'id_name', 'id_description', 'id_industry', 
                'id_stage', 'id_location', 'id_founding_date', 'id_market'
            ];
            
            let isValid = true;
            requiredFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field && !field.value.trim()) {
                    isValid = false;
                    field.classList.add('is-invalid');
                } else if (field) {
                    field.classList.remove('is-invalid');
                }
            });

            if (!isValid) {
                e.preventDefault();
                alert('Please fill in all required fields.');
                return;
            }

            // Show loading state
            const submitBtn = form.querySelector('button[type="submit"]');
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>Saving...';
            }
        });

        // Preview functionality
        const previewBtn = document.getElementById('previewBtn');
        if (previewBtn) {
            previewBtn.addEventListener('click', function() {
                alert('Preview functionality would show how the startup page will look with current changes.');
            });
        }

        // REMOVED: Auto-format number inputs on blur for financial fields
        // Only keep for team_size if you want formatting there
        const teamSizeInput = document.getElementById('id_team_size');
        if (teamSizeInput) {
            teamSizeInput.addEventListener('blur', function() {
                if (this.value && !isNaN(this.value)) {
                    this.value = parseFloat(this.value).toLocaleString();
                }
            });
            
            teamSizeInput.addEventListener('focus', function() {
                if (this.value) {
                    this.value = this.value.replace(/,/g, '');
                }
            });
        }

        // Add proper number handling for financial fields without formatting
        const financialInputs = ['id_valuation', 'id_monthly_revenue'];
        financialInputs.forEach(id => {
            const input = document.getElementById(id);
            if (input) {
                // Ensure the value is a proper number when submitting
                input.addEventListener('blur', function() {
                    if (this.value && !isNaN(this.value)) {
                        // Just ensure it's a valid number, don't format with commas
                        this.value = parseFloat(this.value);
                    }
                });
            }
        });
    });
</script>
{% endblock %}